<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Google Sans', Arial, sans-serif; padding: 16px; background: #f8f9fa; font-size: 14px; }
    
    .header { 
      background: linear-gradient(135deg, #8e44ad 0%, #3498db 100%); 
      color: white; 
      padding: 16px; 
      border-radius: 8px 8px 0 0; 
      margin: -16px -16px 16px -16px; 
    }
    
    h2 { font-size: 18px; margin: 0; }
    .subtitle { font-size: 12px; opacity: 0.9; margin-top: 4px; }
    
    .section { 
      background: white; 
      border-radius: 8px; 
      padding: 16px; 
      margin-bottom: 12px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
    }
    
    .section-title { 
      font-size: 13px; 
      font-weight: 600; 
      color: #5f6368; 
      margin-bottom: 12px; 
    }
    
    .info-box {
      background: #e8f4f8;
      border-left: 4px solid #3498db;
      padding: 12px;
      margin-bottom: 16px;
      font-size: 12px;
      border-radius: 4px;
    }
    
    .warning-box {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 12px;
      margin-bottom: 16px;
      font-size: 12px;
      border-radius: 4px;
    }
    
    .form-group { margin-bottom: 12px; }
    
    label { 
      display: block; 
      font-size: 12px; 
      font-weight: 500; 
      color: #5f6368; 
      margin-bottom: 6px; 
    }
    
    input, textarea { 
      width: 100%; 
      padding: 8px 12px; 
      border: 1px solid #dadce0; 
      border-radius: 4px; 
      font-size: 13px; 
      font-family: inherit; 
    }
    
    input:focus, textarea:focus { 
      outline: none; 
      border-color: #8e44ad; 
      box-shadow: 0 0 0 2px rgba(142, 68, 173, 0.1); 
    }
    
    textarea { 
      resize: vertical; 
      min-height: 80px; 
      font-family: monospace;
    }
    
    .btn { 
      width: 100%; 
      padding: 12px 16px; 
      border: none; 
      border-radius: 6px; 
      font-size: 14px; 
      font-weight: 500; 
      cursor: pointer; 
      transition: all 0.2s; 
    }
    
    .btn-primary { 
      background: #8e44ad; 
      color: white; 
    }
    
    .btn-primary:hover { 
      background: #71368a; 
      transform: translateY(-1px); 
      box-shadow: 0 4px 8px rgba(142, 68, 173, 0.3); 
    }
    
    .btn-primary:disabled {
      background: #dadce0;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-secondary { 
      background: #e8f0fe; 
      color: #8e44ad; 
      margin-top: 8px;
    }
    
    .btn-secondary:hover { 
      background: #d2e3fc; 
    }
    
    .hw-list { 
      max-height: 200px; 
      overflow-y: auto; 
    }
    
    .hw-item { 
      padding: 10px; 
      background: #f8f9fa; 
      border-radius: 4px; 
      margin-bottom: 6px; 
      font-size: 12px; 
      display: flex; 
      align-items: flex-start;
      justify-content: space-between; 
    }
    
    .hw-info {
      flex: 1;
      font-family: monospace;
    }
    
    .hw-text {
      font-weight: 600;
      color: #8e44ad;
      margin-bottom: 4px;
    }
    
    .hw-meta {
      font-size: 11px;
      color: #5f6368;
    }
    
    .delete-btn { 
      background: none; 
      border: none; 
      color: #ea4335; 
      cursor: pointer; 
      padding: 4px 8px; 
      border-radius: 4px; 
      font-size: 16px; 
      flex-shrink: 0;
    }
    
    .delete-btn:hover { 
      background: #fce8e6; 
    }
    
    .empty-state { 
      text-align: center; 
      color: #80868b; 
      font-size: 12px; 
      padding: 20px; 
    }
    
    .help-text { 
      font-size: 11px; 
      color: #80868b; 
      margin-top: 4px; 
      font-style: italic; 
    }
    
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }
    
    .status-ready { background: #34a853; }
    .status-waiting { background: #fbbc04; }
    .status-error { background: #ea4335; }
  </style>
</head>
<body>
  <div class="header">
    <h2>‚úçÔ∏è Handwriting Manager</h2>
    <div class="subtitle">Place handwriting with visual precision</div>
  </div>
  
  <div class="info-box">
    <strong>üìê How it works:</strong><br>
    1. Add a text box to your slide<br>
    2. Move & rotate it to desired position<br>
    3. Select it, then fill form below<br>
    4. Click "Assign" - text appears in box!
  </div>
  
  <div id="selectionStatus" class="section">
    <div class="section-title">üìç Selection Status</div>
    <div id="statusMessage" style="font-size:12px;color:#5f6368;">
      <span class="status-indicator status-waiting"></span>
      Checking selection...
    </div>
  </div>
  
  <div class="section">
    <div class="section-title">‚úèÔ∏è Handwriting Data</div>
    
    <div class="form-group">
      <label>Text (supports LaTeX):</label>
      <textarea id="hwText" placeholder="e.g., Constant Acceleration! or $v = at$"></textarea>
      <div class="help-text">Use $...$ for math formulas</div>
    </div>
    
    <div class="form-group">
      <label>Font Size (pt):</label>
      <input type="number" id="hwSize" value="12" min="8" max="24" step="1">
      <div class="help-text">Recommended: 10-14 for notes</div>
    </div>
    
    <button id="assignBtn" class="btn btn-primary" onclick="assignHandwriting()" disabled>
      üìå Assign as Handwriting
    </button>
    
    <button class="btn btn-secondary" onclick="refreshStatus()">
      üîÑ Refresh Selection
    </button>
  </div>
  
  <div class="section">
    <div class="section-title">üìã Current Slide Handwriting</div>
    <div id="hwList" class="hw-list">
      <div class="empty-state">Loading...</div>
    </div>
  </div>
  
  <div class="warning-box" style="font-size:11px;">
    üí° <strong>Tip:</strong> After assigning, you can freely move/rotate the yellow box. 
    Position will be read at export time!
  </div>
  
  <script>
    let currentStatus = null;
    
    window.onload = function() {
      refreshStatus();
      loadHandwritingList();
      
      setInterval(refreshStatus, 3000);
    };
    
    function refreshStatus() {
      google.script.run
        .withSuccessHandler(updateStatus)
        .withFailureHandler(function(error) {
          updateStatus({
            hasSelection: false,
            isValid: false,
            message: 'Error: ' + error.message
          });
        })
        .getSelectedElementInfo();
    }
    
    function updateStatus(status) {
      currentStatus = status;
      const statusEl = document.getElementById('statusMessage');
      const assignBtn = document.getElementById('assignBtn');
      
      if (!status.hasSelection) {
        statusEl.innerHTML = '<span class="status-indicator status-error"></span>' +
                           'No selection. Please select a text box in the slide.';
        assignBtn.disabled = true;
      } else if (!status.isValid) {
        statusEl.innerHTML = '<span class="status-indicator status-error"></span>' +
                           status.message;
        assignBtn.disabled = true;
      } else if (status.isHandwriting) {
        statusEl.innerHTML = '<span class="status-indicator status-ready"></span>' +
                           '‚úÖ ' + status.message + '<br>' +
                           '<small style="color:#80868b;">Current text: "' + status.currentText + '"</small>';
        assignBtn.disabled = false;
        assignBtn.textContent = 'üîÑ Update Handwriting';
      } else {
        statusEl.innerHTML = '<span class="status-indicator status-ready"></span>' +
                           '‚úÖ ' + status.message;
        assignBtn.disabled = false;
        assignBtn.textContent = 'üìå Assign as Handwriting';
      }
    }
    
    function assignHandwriting() {
      const text = document.getElementById('hwText').value.trim();
      const size = document.getElementById('hwSize').value;
      
      if (!text) {
        alert('‚ö†Ô∏è Please enter text for handwriting');
        return;
      }
      
      if (!size || size < 8 || size > 24) {
        alert('‚ö†Ô∏è Please enter a valid font size (8-24)');
        return;
      }
      
      const btn = document.getElementById('assignBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Assigning...';
      
      google.script.run
        .withSuccessHandler(function(result) {
          alert('‚úÖ ' + result.message);
          
          document.getElementById('hwText').value = '';
          document.getElementById('hwSize').value = '12';
          
          refreshStatus();
          loadHandwritingList();
          
          btn.disabled = false;
          btn.textContent = 'üìå Assign as Handwriting';
        })
        .withFailureHandler(function(error) {
          alert('‚ùå Error: ' + error.message);
          btn.disabled = false;
          btn.textContent = 'üìå Assign as Handwriting';
        })
        .assignHandwriting(text, size);
    }
    
    function loadHandwritingList() {
      google.script.run
        .withSuccessHandler(renderHandwritingList)
        .getCurrentSlideHandwriting();
    }
    
    function renderHandwritingList(hwList) {
      const listEl = document.getElementById('hwList');
      
      if (!hwList || hwList.length === 0) {
        listEl.innerHTML = '<div class="empty-state">No handwriting in this slide</div>';
        return;
      }
      
      let html = '';
      
      hwList.forEach(function(hw) {
        html += '<div class="hw-item">' +
                '<div class="hw-info">' +
                '<div class="hw-text">‚úçÔ∏è ' + hw.text + '</div>' +
                '<div class="hw-meta">Size: ' + hw.size + 'pt</div>' +
                '</div>' +
                '<button class="delete-btn" onclick="deleteHandwriting(\'' + hw.id + '\')">üóëÔ∏è</button>' +
                '</div>';
      });
      
      listEl.innerHTML = html;
    }
    
    function deleteHandwriting(id) {
      if (!confirm('Delete this handwriting?\n\nThe text box will remain, but handwriting data will be removed.')) {
        return;
      }
      
      google.script.run
        .withSuccessHandler(function() {
          alert('‚úÖ Handwriting deleted');
          loadHandwritingList();
          refreshStatus();
        })
        .withFailureHandler(function(error) {
          alert('‚ùå Error: ' + error.message);
        })
        .deleteHandwritingById(id);
    }
  </script>
</body>
</html>
